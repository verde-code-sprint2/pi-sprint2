<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrotis - Dashboard</title>
    <!-- Estilos -->
    <link rel="stylesheet" href="./css/globais.css">
    <link rel="stylesheet" href="./css/dashboard.css">
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100&display=swap" rel="stylesheet">
    <!-- Favicon -->
    <link rel="shortcut icon" href="./assets/images/logo_black.ico" type="image/x-icon">
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="js/funcoes_dashboard.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <a href="./logged.html"><img class="logo" src="./assets/images/logo.ico" alt=""></a>
        <ul>
            <a>
                <li onclick="inicio()">Inicio</li>
            </a>

            <a>
                <li onclick="register()">Cadastro</li>
            </a>

            <a>
                <li onclick="lote()">Lotes</li>
            </a>    

        </ul>
    </div>
    <!-- <div>
        <section>
            <h1>Sensor LM35 - Temperatura</h1>
            <h2>Média: <label id='average'>0.00</label></h2>
        </section>
        <section style="width:50%">
            <canvas id="chart"></canvas>
            <section>
    </div>
    <div>
        <section>
            <h1>Sensor DHT11 - Umidade</h1>
            <h2>Média: <label id='averageHumidity'>0.00</label></h2>
        </section>
        <section style="width:50%">
            <canvas id="chart-humidity"></canvas>
            <section>
    </div> -->
    <span id="content_start">
        <div class="container">
            <div>

                <section>
                    <h2>Sensor DHT11 - Temperatura/Umidade</h2>
                    <h3>Média temperatura: <label id='averageTemp'>0.00</label></h3>
                    <h3>Média umidade: <label id='averageMoisture'>0.00</label></h3>
                    <h3>Altitude: <label id='alt'>0.00</label></h3>
                    <h3>Temperatura ideal - 18°C à 23°C</h3>
                    <h3>Umidade ideal - 80%</h3>
                    <span>
                        <span>Lote </span>
                        <select>
                            <option value="001">001</option>
                            <option value="002">002</option>
                            <option value="003">003</option>
                        </select>
                    </span>
                </section>
                <section style="width:80vw">
                    <canvas id="chart"></canvas>
                    <section>
            </div>
            <div class="alertas">
                <h2>Alertas</h2>
                <div id="div_alertas">
                    <div id="temp">
                        <h3>Temperatura</h3>
                    </div>
                    <div id="umidade">
                        <h3>Umidade</h3>
                    </div>
                </div>
            </div>
        </div>
    </span>
    <span style="display: none;" id="content_nav">
        <div class="container">
            <div class="bar">
                <div class="buttons">
                    <button class="buttons_cadastro" div="content_lote" >Lote</button>
                    <button class="buttons_cadastro" div="content_safra" >Safra</button>
                    <!-- <button class="buttons_cadastro" div="content_insumo" >Insumo</button> -->
                    <!-- <button class="buttons_cadastro" div="content_planta" >Planta</button> -->
                </div>
            </div>
        </span>

        <span class="conteudo_span show" id="content_lote">

            <table>
                <th>Número</th>
                <th>Plantas/ha</th>
                <th>Tipo</th>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>3000 ha</td>
                    <td>Arábica</td>
                </tr>
            </table>
        </span>
        
        <span id="content_safra" class="conteudo_span">
            <section id="safra">
                <div class="conteudo">
                    <div class="year">
                        <div class="title">Safra</div>
                        <div class="text"></div>
                    </div>

                    <div class="graph">
                        <div class="title">Gráfico</div>
                        <div class="graphic"></div>
                    </div>

                    <div class="colaborator">
                        <div class="title">Colaboradores</div>
                        <div class="text"></div>
                    </div>
                </div>
            </section>
        </span>
    </div>

</body>

</html>
<!-- <script>
    var context = document.getElementById("chart").getContext("2d");
    context.canvas.width = 1000;
    context.canvas.height = 300;

    var configuration = {
        type: 'line',
        data: {
            datasets: [{
                label: "Temperatura x Tempo",
                type: 'line',
                borderColor: ['#ff3232'],
                backgroundColor: ['#ff7f7f']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Temperature'
                    },
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chart = new Chart(context, configuration);

    //Função para obter os dados de temperatura do server

    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTemp = 0;
    this.time = 0;

    function get_data() {

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3333/api/temperature', false);
        http.send(null);

        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0) {
            return;
        }

        var _lastIndexTemp = this.lastIndexTemp;
        this.lastIndexTemp = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(this.time++);
            chart.data.datasets[0].data.push(parseFloat(data));
            chart.update();
        });

        document.getElementById('average').textContent = obj.average;
    }

    //Second Graphic

    var context2 = document.getElementById("chart-humidity").getContext("2d");
    context2.canvas.width = 1000;
    context2.canvas.height = 300;

    var humidity = {
        type: 'line',
        data: {
            datasets: [{
                label: "Umidade x Tempo",
                type: 'line',
                borderColor: ['#3232ff'],
                backgroundColor: ['#9999ff']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Humidity'
                    },
                    ticks: {
                        beginAtZero: true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chartHumidity = new Chart(context2, humidity);

    //Função para obter os dados de temperatura do server


    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTempHumidity = 0;
    this.timeHumidity = 0;

    function get_dataHumidity() {

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3333/api/humidity', false);
        http.send(null);

        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0) {
            return;
        }

        var _lastIndexTemp = this.lastIndexTempHumidity;
        this.lastIndexTempHumidity = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chartHumidity.data.labels.length == 10 && chartHumidity.data.datasets[0].data.length == 10) {
                chartHumidity.data.labels.shift();
                chartHumidity.data.datasets[0].data.shift();
            }

            chartHumidity.data.labels.push(this.time++);
            chartHumidity.data.datasets[0].data.push(parseFloat(data));
            chartHumidity.update();
        });

        document.getElementById('averageHumidity').textContent = obj.average;
    }

    get_dataHumidity();

    function sendData() {
        var http = new XMLHttpRequest();
        http.open('POST', 'http://localhost:3333/api/sendData', false);
        http.send(null);
    }

    setInterval(() => {
        get_data();
        get_dataHumidity();
        sendData();
    }, 2000);
</script> -->
<script>
    var lotes = [];
    var context = document.getElementById("chart").getContext("2d");

    context.canvas.width = 1000;
    context.canvas.height = 300;

    var configuration = {
        type: 'line',
        data: {
            datasets: [{
                    label: "Umidade",
                    type: 'line',
                    yAxisID: 'A',
                    borderColor: ['#00F'],
                    // backgroundColor: ['#00D']
                },
                {
                    label: "Temperatura",
                    type: 'line',
                    yAxisID: 'B',
                    borderColor: ['#ff3232'],
                    // backgroundColor: ['#ff7f7f']
                }
            ],
        },
        options: {
            z: 1,
            scales: {
                xAxes: [{
                    // distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                        id: 'B',
                        type: 'linear',
                        position: 'left',
                        max: 50,
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperatura'
                        },
                        ticks: {
                            beginAtZero: true,
                        }
                    },
                    {
                        id: 'A',
                        type: 'linear',
                        position: 'right',
                        max: 100,
                        min: 40,
                        scaleLabel: {
                            display: true,
                            labelString: 'Umidade'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }
                ]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chart = new Chart(context, configuration);

    //Função para obter os dados de temperatura do server
    //Seria mais interessante fazer isso com WebSocket, porém para fins academicos, os dados serão atualizados via HTTP

    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTemp = 0;
    this.time = 0;

    function get_data() {

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3333/api/allData', false);
        http.send(null);

        var obj = JSON.parse(http.responseText);
        if (obj.dataTemp.length == 0) {
            return;
        }

        var _lastIndexTemp = this.lastIndexTemp;

        this.lastIndexTemp = obj.dataTemp.length;
        listTemp = obj.dataTemp.slice(_lastIndexTemp);
        // console.log(obj.alertas)
        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chart.data.labels.length == 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }

            chart.data.labels.push(this.time++);
            //Dados de umidade vindos da API
            // console.log('obj umidade temp', obj.dataHumidity, obj.dataTemp)
            chart.data.datasets[0].data.push(parseFloat(obj.dataHumidity[obj.dataHumidity.length - 1]));
            //Dados de temperatura vindos da API
            chart.data.datasets[1].data.push(parseFloat(obj.dataTemp[obj.dataTemp.length - 1]));
            chart.update();
            // document.getElementById('temp').innerHTML = '<h3>Temperatura</h3>';
            // obj.alertasTemp.forEach(alerta => {
            //     document.getElementById('temp').innerHTML += '<p>' + alerta + '</p>';
            // })
            // document.getElementById('umidade').innerHTML = '<h3>Umidade</h3>';
            // obj.alertasUmidade.forEach(alerta => {
            //     document.getElementById('umidade').innerHTML += '<p>' + alerta + '</p>';
            // })
        });
        document.getElementById('averageTemp').textContent = obj.averageTemp + '°C';
        document.getElementById('averageMoisture').textContent = obj.averageHumidity + '%';
        // document.getElementById('alt').textContent = obj.altitude + 'm';
    }

    get_data();

    function sendData() {
        var http = new XMLHttpRequest();
        http.open('POST', 'http://localhost:3333/api/sendData', false);
        http.send(null);
    }

    setInterval(() => {
        get_data();
        sendData();
        // A Cada 5000ms execute a função get_data()
    }, 2000);

</script>
