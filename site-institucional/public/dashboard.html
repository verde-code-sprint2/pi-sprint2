<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrotis - Dashboard</title>
    <!-- Estilos -->
    <link rel="stylesheet" href="./css/globais.css">
    <link rel="stylesheet" href="./css/dashboard.css">
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100&display=swap" rel="stylesheet">
    <!-- Favicon -->
    <link rel="shortcut icon" href="./assets/images/LOGO_PNG.png" type="image/x-icon">
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>

<body>
    <div class="navbar">
        <a href="./logged.html"><img class="logo" src="./assets/images/logo.ico" alt=""></a>
        <ul>
            <a href="./index.html">
                <li>Inicio</li>
            </a>

        </ul>
    </div>

    <div class="container">
        <div>

            <section>
                <h2>Sensor DHT11 - Temperatura/Umidade</h2>
                <h3>Média temperatura: <label id='averageTemp'>0.00</label></h3>
                <h3>Média umidade: <label id='averageMoisture'>0.00</label></h3>
                <h3>Altitude: <label id='alt'>0.00</label></h3>
                <span>
                    <span>Lote </span>
                    <select>
                        <option value="001">001</option>
                        <option value="002">002</option>
                        <option value="003">003</option>
                    </select>
                </span>
            </section>
            <section style="width:80vw">
                <canvas id="chart"></canvas>
                <section>
        </div>
        <div class="alertas">
            <h2>Alertas</h2>
            <div id="div_alertas">
                <div id="temp">
                    <h3>Temperatura</h3>
                </div>
                <div id="umidade">
                    <h3>Umidade</h3>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    var context = document.getElementById("chart").getContext("2d");

    context.canvas.width = 1000;
    context.canvas.height = 300;

    var configuration = {
        type: 'line',
        data: {
            datasets: [{
                    label: "Umidade",
                    type: 'line',
                    yAxisID: 'A',
                    borderColor: ['#00F'],
                    // backgroundColor: ['#00D']
                },
                {
                    label: "Temperatura",
                    type: 'line',
                    yAxisID: 'B',
                    borderColor: ['#ff3232'],
                    // backgroundColor: ['#ff7f7f']
                }
            ],
        },
        options: {
            z: 1,
            scales: {
                xAxes: [{
                    // distribution: 'series',
                    ticks: {
                        beginAtZero: true
                    }
                }],
                yAxes: [{
                        id: 'B',
                        type: 'linear',
                        position: 'left',
                        max: 50,
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperatura'
                        },
                        ticks: {
                            beginAtZero: true,
                        }
                    },
                    {
                        id: 'A',
                        type: 'linear',
                        position: 'right',
                        max: 100,
                        min: 40,
                        scaleLabel: {
                            display: true,
                            labelString: 'Umidade'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }
                ]
            },
            animation: {
                duration: 0
            }
        }
    };

    var chart = new Chart(context, configuration);

    //Função para obter os dados de temperatura do server
    //Seria mais interessante fazer isso com WebSocket, porém para fins academicos, os dados serão atualizados via HTTP

    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTemp = 0;
    this.time = 0;

    function get_data() {

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:3000/api', false);
        http.send(null);

        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0) {
            return;
        }
        var _lastIndexTemp = this.lastIndexTemp;
        this.lastIndexTemp = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);
        console.log(obj.alertas)
        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }

            chart.data.labels.push(this.time++);
            //Dados de umidade vindos da API
            chart.data.datasets[0].data.push(parseFloat(data[0]));
            //Dados de temperatura vindos da API
            chart.data.datasets[1].data.push(parseFloat(data[1]));
            chart.update();
            document.getElementById('temp').innerHTML = '<h3>Temperatura</h3>';
            obj.alertasTemp.forEach(alerta => {
                document.getElementById('temp').innerHTML += '<p>' + alerta + '</p>';
            })
            document.getElementById('umidade').innerHTML = '<h3>Umidade</h3>';
            obj.alertasUmidade.forEach(alerta => {
                document.getElementById('umidade').innerHTML += '<p>' + alerta + '</p>';
            })
        });
        document.getElementById('averageTemp').textContent = obj.averageTemp + '°C';
        document.getElementById('averageMoisture').textContent = obj.averageMoisture + '%';
        document.getElementById('alt').textContent = obj.altitude + 'm';
    }

    get_data();

    setInterval(() => {
        get_data();
        // A Cada 5000ms execute a função get_data()
    }, 2000);
</script>